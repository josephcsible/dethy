<!DOCTYPE html>
<html lang="en">
  <!--
    Dethy Mafia game auto-moderator
    Copyright (C) 2021  Joseph C. Sible

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->
  <head>
    <title>Dethy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
      .mafia {
        color: red;
      }

      .town {
        color: green;
      }
    </style>
    <!--
      The following script tag contains the minified HTM + Preact module from
      https://unpkg.com/htm/preact/standalone.module.js modified to work inline.

      HTM's license:

      Copyright 2018 Google Inc. All Rights Reserved.
      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at
          http://www.apache.org/licenses/LICENSE-2.0
      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.

      Preact's license:

      The MIT License (MIT)

      Copyright (c) 2015-present Jason Miller

      Permission is hereby granted, free of charge, to any person obtaining a copy
      of this software and associated documentation files (the "Software"), to deal
      in the Software without restriction, including without limitation the rights
      to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
      copies of the Software, and to permit persons to whom the Software is
      furnished to do so, subject to the following conditions:

      The above copyright notice and this permission notice shall be included in all
      copies or substantial portions of the Software.

      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
      AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
      LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
      OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
      SOFTWARE.

    -->
    <script>"use strict";window.htm_preact=(function(){var e,n,_,t,o,r,u,l={},i=[],c=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function s(e,n){for(var _ in n)e[_]=n[_];return e}function f(e){var n=e.parentNode;n&&n.removeChild(e)}function a(n,_,t){var o,r,u,l={};for(u in _)"key"==u?o=_[u]:"ref"==u?r=_[u]:l[u]=_[u];if(arguments.length>2&&(l.children=arguments.length>3?e.call(arguments,2):t),"function"==typeof n&&null!=n.defaultProps)for(u in n.defaultProps)void 0===l[u]&&(l[u]=n.defaultProps[u]);return p(n,l,o,r,null)}function p(e,t,o,r,u){var l={type:e,props:t,key:o,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==u?++_:u};return null!=n.vnode&&n.vnode(l),l}function h(e){return e.children}function d(e,n){this.props=e,this.context=n}function v(e,n){if(null==n)return e.__?v(e.__,e.__.__k.indexOf(e)+1):null;for(var _;n<e.__k.length;n++)if(null!=(_=e.__k[n])&&null!=_.__e)return _.__e;return"function"==typeof e.type?v(e):null}function y(e){var n,_;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,n=0;n<e.__k.length;n++)if(null!=(_=e.__k[n])&&null!=_.__e){e.__e=e.__c.base=_.__e;break}return y(e)}}function m(e){(!e.__d&&(e.__d=!0)&&t.push(e)&&!g.__r++||r!==n.debounceRendering)&&((r=n.debounceRendering)||o)(g)}function g(){for(var e;g.__r=t.length;)e=t.sort(function(e,n){return e.__v.__b-n.__v.__b}),t=[],e.some(function(e){var n,_,t,o,r,u;e.__d&&(r=(o=(n=e).__v).__e,(u=n.__P)&&(_=[],(t=s({},o)).__v=o.__v+1,P(u,o,t,n.__n,void 0!==u.ownerSVGElement,null!=o.__h?[r]:null,_,null==r?v(o):r,o.__h),D(_,o),o.__e!=r&&y(o)))})}function k(e,n,_,t,o,r,u,c,s,f){var a,d,y,m,g,k,x,H=t&&t.__k||i,E=H.length;for(_.__k=[],a=0;a<n.length;a++)if(null!=(m=_.__k[a]=null==(m=n[a])||"boolean"==typeof m?null:"string"==typeof m||"number"==typeof m||"bigint"==typeof m?p(null,m,null,null,m):Array.isArray(m)?p(h,{children:m},null,null,null):m.__b>0?p(m.type,m.props,m.key,null,m.__v):m)){if(m.__=_,m.__b=_.__b+1,null===(y=H[a])||y&&m.key==y.key&&m.type===y.type)H[a]=void 0;else for(d=0;d<E;d++){if((y=H[d])&&m.key==y.key&&m.type===y.type){H[d]=void 0;break}y=null}P(e,m,y=y||l,o,r,u,c,s,f),g=m.__e,(d=m.ref)&&y.ref!=d&&(x||(x=[]),y.ref&&x.push(y.ref,null,m),x.push(d,m.__c||g,m)),null!=g?(null==k&&(k=g),"function"==typeof m.type&&null!=m.__k&&m.__k===y.__k?m.__d=s=b(m,s,e):s=C(e,m,y,H,g,s),f||"option"!==_.type?"function"==typeof _.type&&(_.__d=s):e.value=""):s&&y.__e==s&&s.parentNode!=e&&(s=v(y))}for(_.__e=k,a=E;a--;)null!=H[a]&&("function"==typeof _.type&&null!=H[a].__e&&H[a].__e==_.__d&&(_.__d=v(t,a+1)),U(H[a],H[a]));if(x)for(a=0;a<x.length;a++)T(x[a],x[++a],x[++a])}function b(e,n,_){var t,o;for(t=0;t<e.__k.length;t++)(o=e.__k[t])&&(o.__=e,n="function"==typeof o.type?b(o,n,_):C(_,o,o,e.__k,o.__e,n));return n}function C(e,n,_,t,o,r){var u,l,i;if(void 0!==n.__d)u=n.__d,n.__d=void 0;else if(null==_||o!=r||null==o.parentNode)e:if(null==r||r.parentNode!==e)e.appendChild(o),u=null;else{for(l=r,i=0;(l=l.nextSibling)&&i<t.length;i+=2)if(l==o)break e;e.insertBefore(o,r),u=r}return void 0!==u?u:o.nextSibling}function x(e,n,_){"-"===n[0]?e.setProperty(n,_):e[n]=null==_?"":"number"!=typeof _||c.test(n)?_:_+"px"}function H(e,n,_,t,o){var r;e:if("style"===n)if("string"==typeof _)e.style.cssText=_;else{if("string"==typeof t&&(e.style.cssText=t=""),t)for(n in t)_&&n in _||x(e.style,n,"");if(_)for(n in _)t&&_[n]===t[n]||x(e.style,n,_[n])}else if("o"===n[0]&&"n"===n[1])r=n!==(n=n.replace(/Capture$/,"")),n=n.toLowerCase()in e?n.toLowerCase().slice(2):n.slice(2),e.l||(e.l={}),e.l[n+r]=_,_?t||e.addEventListener(n,r?S:E,r):e.removeEventListener(n,r?S:E,r);else if("dangerouslySetInnerHTML"!==n){if(o)n=n.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if("href"!==n&&"list"!==n&&"form"!==n&&"tabIndex"!==n&&"download"!==n&&n in e)try{e[n]=null==_?"":_;break e}catch(e){}"function"==typeof _||(null!=_&&(!1!==_||"a"===n[0]&&"r"===n[1])?e.setAttribute(n,_):e.removeAttribute(n))}}function E(e){this.l[e.type+!1](n.event?n.event(e):e)}function S(e){this.l[e.type+!0](n.event?n.event(e):e)}function P(e,_,t,o,r,u,l,i,c){var f,a,p,v,y,m,g,b,C,x,H,E=_.type;if(void 0!==_.constructor)return null;null!=t.__h&&(c=t.__h,i=_.__e=t.__e,_.__h=null,u=[i]),(f=n.__b)&&f(_);try{e:if("function"==typeof E){if(b=_.props,C=(f=E.contextType)&&o[f.__c],x=f?C?C.props.value:f.__:o,t.__c?g=(a=_.__c=t.__c).__=a.__E:("prototype"in E&&E.prototype.render?_.__c=a=new E(b,x):(_.__c=a=new d(b,x),a.constructor=E,a.render=A),C&&C.sub(a),a.props=b,a.state||(a.state={}),a.context=x,a.__n=o,p=a.__d=!0,a.__h=[]),null==a.__s&&(a.__s=a.state),null!=E.getDerivedStateFromProps&&(a.__s==a.state&&(a.__s=s({},a.__s)),s(a.__s,E.getDerivedStateFromProps(b,a.__s))),v=a.props,y=a.state,p)null==E.getDerivedStateFromProps&&null!=a.componentWillMount&&a.componentWillMount(),null!=a.componentDidMount&&a.__h.push(a.componentDidMount);else{if(null==E.getDerivedStateFromProps&&b!==v&&null!=a.componentWillReceiveProps&&a.componentWillReceiveProps(b,x),!a.__e&&null!=a.shouldComponentUpdate&&!1===a.shouldComponentUpdate(b,a.__s,x)||_.__v===t.__v){a.props=b,a.state=a.__s,_.__v!==t.__v&&(a.__d=!1),a.__v=_,_.__e=t.__e,_.__k=t.__k,_.__k.forEach(function(e){e&&(e.__=_)}),a.__h.length&&l.push(a);break e}null!=a.componentWillUpdate&&a.componentWillUpdate(b,a.__s,x),null!=a.componentDidUpdate&&a.__h.push(function(){a.componentDidUpdate(v,y,m)})}a.context=x,a.props=b,a.state=a.__s,(f=n.__r)&&f(_),a.__d=!1,a.__v=_,a.__P=e,f=a.render(a.props,a.state,a.context),a.state=a.__s,null!=a.getChildContext&&(o=s(s({},o),a.getChildContext())),p||null==a.getSnapshotBeforeUpdate||(m=a.getSnapshotBeforeUpdate(v,y)),H=null!=f&&f.type===h&&null==f.key?f.props.children:f,k(e,Array.isArray(H)?H:[H],_,t,o,r,u,l,i,c),a.base=_.__e,_.__h=null,a.__h.length&&l.push(a),g&&(a.__E=a.__=null),a.__e=!1}else null==u&&_.__v===t.__v?(_.__k=t.__k,_.__e=t.__e):_.__e=w(t.__e,_,t,o,r,u,l,c);(f=n.diffed)&&f(_)}catch(e){_.__v=null,(c||null!=u)&&(_.__e=i,_.__h=!!c,u[u.indexOf(i)]=null),n.__e(e,_,t)}}function D(e,_){n.__c&&n.__c(_,e),e.some(function(_){try{e=_.__h,_.__h=[],e.some(function(e){e.call(_)})}catch(e){n.__e(e,_.__v)}})}function w(n,_,t,o,r,u,i,c){var s,a,p,h=t.props,d=_.props,y=_.type,m=0;if("svg"===y&&(r=!0),null!=u)for(;m<u.length;m++)if((s=u[m])&&(s===n||(y?s.localName==y:3==s.nodeType))){n=s,u[m]=null;break}if(null==n){if(null===y)return document.createTextNode(d);n=r?document.createElementNS("http://www.w3.org/2000/svg",y):document.createElement(y,d.is&&d),u=null,c=!1}if(null===y)h===d||c&&n.data===d||(n.data=d);else{if(u=u&&e.call(n.childNodes),a=(h=t.props||l).dangerouslySetInnerHTML,p=d.dangerouslySetInnerHTML,!c){if(null!=u)for(h={},m=0;m<n.attributes.length;m++)h[n.attributes[m].name]=n.attributes[m].value;(p||a)&&(p&&(a&&p.__html==a.__html||p.__html===n.innerHTML)||(n.innerHTML=p&&p.__html||""))}if(function(e,n,_,t,o){var r;for(r in _)"children"===r||"key"===r||r in n||H(e,r,null,_[r],t);for(r in n)o&&"function"!=typeof n[r]||"children"===r||"key"===r||"value"===r||"checked"===r||_[r]===n[r]||H(e,r,n[r],_[r],t)}(n,d,h,r,c),p)_.__k=[];else if(m=_.props.children,k(n,Array.isArray(m)?m:[m],_,t,o,r&&"foreignObject"!==y,u,i,u?u[0]:t.__k&&v(t,0),c),null!=u)for(m=u.length;m--;)null!=u[m]&&f(u[m]);c||("value"in d&&void 0!==(m=d.value)&&(m!==n.value||"progress"===y&&!m)&&H(n,"value",m,h.value,!1),"checked"in d&&void 0!==(m=d.checked)&&m!==n.checked&&H(n,"checked",m,h.checked,!1))}return n}function T(e,_,t){try{"function"==typeof e?e(_):e.current=_}catch(e){n.__e(e,t)}}function U(e,_,t){var o,r;if(n.unmount&&n.unmount(e),(o=e.ref)&&(o.current&&o.current!==e.__e||T(o,null,_)),null!=(o=e.__c)){if(o.componentWillUnmount)try{o.componentWillUnmount()}catch(e){n.__e(e,_)}o.base=o.__P=null}if(o=e.__k)for(r=0;r<o.length;r++)o[r]&&U(o[r],_,"function"!=typeof e.type);t||null==e.__e||f(e.__e),e.__e=e.__d=void 0}function A(e,n,_){return this.constructor(e,_)}function M(_,t,o){var r,u,i;n.__&&n.__(_,t),u=(r="function"==typeof o)?null:o&&o.__k||t.__k,i=[],P(t,_=(!r&&o||t).__k=a(h,null,[_]),u||l,l,void 0!==t.ownerSVGElement,!r&&o?[o]:u?null:t.firstChild?e.call(t.childNodes):null,i,!r&&o?o:u?u.__e:t.firstChild,r),D(i,_)}function F(e,n){var _={__c:n="__cC"+u++,__:e,Consumer:function(e,n){return e.children(n)},Provider:function(e){var _,t;return this.getChildContext||(_=[],(t={})[n]=this,this.getChildContext=function(){return t},this.shouldComponentUpdate=function(e){this.props.value!==e.value&&_.some(m)},this.sub=function(e){_.push(e);var n=e.componentWillUnmount;e.componentWillUnmount=function(){_.splice(_.indexOf(e),1),n&&n.call(e)}}),e.children}};return _.Provider.__=_.Consumer.contextType=_}e=i.slice,n={__e:function(e,n){for(var _,t,o;n=n.__;)if((_=n.__c)&&!_.__)try{if((t=_.constructor)&&null!=t.getDerivedStateFromError&&(_.setState(t.getDerivedStateFromError(e)),o=_.__d),null!=_.componentDidCatch&&(_.componentDidCatch(e),o=_.__d),o)return _.__E=_}catch(n){e=n}throw e}},_=0,d.prototype.setState=function(e,n){var _;_=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=s({},this.state),"function"==typeof e&&(e=e(s({},_),this.props)),e&&s(_,e),null!=e&&this.__v&&(n&&this.__h.push(n),m(this))},d.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),m(this))},d.prototype.render=h,t=[],o="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,g.__r=0,u=0;var L,N,W,R=0,I=[],O=n.__b,V=n.__r,q=n.diffed,B=n.__c,$=n.unmount;function j(e,_){n.__h&&n.__h(N,e,R||_),R=0;var t=N.__H||(N.__H={__:[],__h:[]});return e>=t.__.length&&t.__.push({}),t.__[e]}function G(e){return R=1,z(ie,e)}function z(e,n,_){var t=j(L++,2);return t.t=e,t.__c||(t.__=[_?_(n):ie(void 0,n),function(e){var n=t.t(t.__[0],e);t.__[0]!==n&&(t.__=[n,t.__[1]],t.__c.setState({}))}],t.__c=N),t.__}function J(e,_){var t=j(L++,3);!n.__s&&le(t.__H,_)&&(t.__=e,t.__H=_,N.__H.__h.push(t))}function K(e,_){var t=j(L++,4);!n.__s&&le(t.__H,_)&&(t.__=e,t.__H=_,N.__h.push(t))}function Q(e){return R=5,Y(function(){return{current:e}},[])}function X(e,n,_){R=6,K(function(){"function"==typeof e?e(n()):e&&(e.current=n())},null==_?_:_.concat(e))}function Y(e,n){var _=j(L++,7);return le(_.__H,n)&&(_.__=e(),_.__H=n,_.__h=e),_.__}function Z(e,n){return R=8,Y(function(){return e},n)}function ee(e){var n=N.context[e.__c],_=j(L++,9);return _.c=e,n?(null==_.__&&(_.__=!0,n.sub(N)),n.props.value):e.__}function ne(e,_){n.useDebugValue&&n.useDebugValue(_?_(e):e)}function _e(e){var n=j(L++,10),_=G();return n.__=e,N.componentDidCatch||(N.componentDidCatch=function(e){n.__&&n.__(e),_[1](e)}),[_[0],function(){_[1](void 0)}]}function te(){I.forEach(function(e){if(e.__P)try{e.__H.__h.forEach(re),e.__H.__h.forEach(ue),e.__H.__h=[]}catch(_){e.__H.__h=[],n.__e(_,e.__v)}}),I=[]}n.__b=function(e){N=null,O&&O(e)},n.__r=function(e){V&&V(e),L=0;var n=(N=e.__c).__H;n&&(n.__h.forEach(re),n.__h.forEach(ue),n.__h=[])},n.diffed=function(e){q&&q(e);var _=e.__c;_&&_.__H&&_.__H.__h.length&&(1!==I.push(_)&&W===n.requestAnimationFrame||((W=n.requestAnimationFrame)||function(e){var n,_=function(){clearTimeout(t),oe&&cancelAnimationFrame(n),setTimeout(e)},t=setTimeout(_,100);oe&&(n=requestAnimationFrame(_))})(te)),N=void 0},n.__c=function(e,_){_.some(function(e){try{e.__h.forEach(re),e.__h=e.__h.filter(function(e){return!e.__||ue(e)})}catch(t){_.some(function(e){e.__h&&(e.__h=[])}),_=[],n.__e(t,e.__v)}}),B&&B(e,_)},n.unmount=function(e){$&&$(e);var _=e.__c;if(_&&_.__H)try{_.__H.__.forEach(re)}catch(e){n.__e(e,_.__v)}};var oe="function"==typeof requestAnimationFrame;function re(e){var n=N;"function"==typeof e.__c&&e.__c(),N=n}function ue(e){var n=N;e.__c=e.__(),N=n}function le(e,n){return!e||e.length!==n.length||n.some(function(n,_){return n!==e[_]})}function ie(e,n){return"function"==typeof n?n(e):n}var ce=function(e,n,_,t){var o;n[0]=0;for(var r=1;r<n.length;r++){var u=n[r++],l=n[r]?(n[0]|=u?1:2,_[n[r++]]):n[++r];3===u?t[0]=l:4===u?t[1]=Object.assign(t[1]||{},l):5===u?(t[1]=t[1]||{})[n[++r]]=l:6===u?t[1][n[++r]]+=l+"":u?(o=e.apply(l,ce(e,l,_,["",null])),t.push(o),l[0]?n[0]|=2:(n[r-2]=0,n[r]=o)):t.push(l)}return t},se=new Map,fe=function(e){var n=se.get(this);return n||(n=new Map,se.set(this,n)),(n=ce(this,n.get(e)||(n.set(e,n=function(e){for(var n,_,t=1,o="",r="",u=[0],l=function(e){1===t&&(e||(o=o.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?u.push(0,e,o):3===t&&(e||o)?(u.push(3,e,o),t=2):2===t&&"..."===o&&e?u.push(4,e,0):2===t&&o&&!e?u.push(5,0,!0,o):t>=5&&((o||!e&&5===t)&&(u.push(t,0,o,_),t=6),e&&(u.push(t,e,0,_),t=6)),o=""},i=0;i<e.length;i++){i&&(1===t&&l(),l(i));for(var c=0;c<e[i].length;c++)n=e[i][c],1===t?"<"===n?(l(),u=[u],t=3):o+=n:4===t?"--"===o&&">"===n?(t=1,o=""):o=n+o[0]:r?n===r?r="":o+=n:'"'===n||"'"===n?r=n:">"===n?(l(),t=1):t&&("="===n?(t=5,_=o,o=""):"/"===n&&(t<5||">"===e[i][c+1])?(l(),3===t&&(u=u[0]),t=u,(u=u[0]).push(2,0,t),t=0):" "===n||"\t"===n||"\n"===n||"\r"===n?(l(),t=2):o+=n),3===t&&"!--"===o&&(t=4,u=u[0])}return l(),u}(e)),n),arguments,[])).length>1?n:n[0]}.bind(a);return({h: a,html: fe,render: M,Component: d,createContext: F,useState: G,useReducer: z,useEffect: J,useLayoutEffect: K,useRef: Q,useImperativeHandle: X,useMemo: Y,useCallback: Z,useContext: ee,useDebugValue: ne,useErrorBoundary: _e});})();</script>
    <script>
      "use strict";
      const { html, Component, render } = window.htm_preact;

      const phases = {
        NAMEENTRY: "nameentry",
        NIGHTPLAYER: "nightplayer",
        NIGHTCHOICE: "nightchoice",
        NIGHTRESULT: "nightresult",
        DAY: "day",
        ENDGAME: "endgame"
      };

      const roles = {
        MAFIAGOON: "Mafia Goon",
        SANECOP: "Town Sane Cop",
        INSANECOP: "Town Insane Cop",
        PARANOIDCOP: "Town Paranoid Cop",
        NAIVECOP: "Town Na√Øve Cop"
      };

      const GUILTY = html`<span class="mafia">Guilty</span>`;
      const INNOCENT = html`<span class="town">Innocent</span>`;

      function shuffleRoles() {
        let array = [roles.MAFIAGOON, roles.SANECOP, roles.INSANECOP, roles.PARANOIDCOP, roles.NAIVECOP];
        for (let i = array.length - 1; i > 0; --i) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getInvestigationResult(investigatorRole, investigateeRole) {
        const guilty = investigatorRole === roles.PARANOIDCOP ? true :
                       investigatorRole === roles.NAIVECOP ? false :
                       investigatorRole === roles.INSANECOP ? investigateeRole !== roles.MAFIAGOON :
                       investigateeRole === roles.MAFIAGOON;
        return guilty ? GUILTY : INNOCENT;
      }

      function NameEntry({ players, updateNames, preventBlunders, updatePreventBlunders, startGame }) {
        return html`
          <form onSubmit=${startGame}>
            Enter player names:
            <ol>
              ${players.map((player, i) => html`
                <li key=${i}><input type="text" value=${player.name} onInput=${updateNames[i]} /></li>
              `)}
            </ol>
            <label><input type="checkbox" checked=${preventBlunders} onClick=${updatePreventBlunders} />Prevent blunders</label><br />
            <button type="submit">Start Game</button>
          </form>
        `;
      }

      function Actions({ actions, showhidden }) {
        return html`
          Action Log:
          <ul>
            ${actions.map(({ action, hidden }, i) => (!hidden || showhidden) && html`
              <li key=${i}>${action}</li>
            `)}
          </ul>
          <hr />
        `;
      }

      class NightChoice extends Component {
        selectPlayer = ({ target: { value } }) => this.setState({ selectedPlayer: parseInt(value) });

        playerDisabled(i) {
          if(i === this.props.playerTurn) {
            return html` <i>(You cannot choose yourself.)</i>`;
          } else if(!this.props.players[i].alive) {
            return html` <i>(You cannot choose dead players.)</i>`;
          } else if(this.props.day === 0 && this.props.players[this.props.playerTurn].role === roles.MAFIAGOON) {
            return html` <i>(The Mafia Goon may not kill on Night 0.)</i>`;
          } else if(this.props.preventBlunders && this.props.players[this.props.playerTurn].investigations[i]) {
            return html` <i>(Blunder: Reinvestigating a player is never useful.)</i>`;
          } else {
            return null;
          }
        }

        blunder() {
          return this.props.preventBlunders && !(this.props.day === 0 && this.props.players[this.props.playerTurn].role === roles.MAFIAGOON) && "(Blunder: Skipping your night action is never useful.)";
        }

        choose = event => {
          event.preventDefault();
          if(this.state.selectedPlayer !== -2) {
            this.props.choose(this.state.selectedPlayer);
          }
        }

        onKeyup = event => {
          if(event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) return;
          if(event.key === '6') {
            event.preventDefault();
            if(!this.blunder()) {
              this.setState({ selectedPlayer: -1 });
            }
          } else if(event.key >= '1' && event.key <= '5') {
            event.preventDefault();
            const selectedPlayer = parseInt(event.key) - 1;
            if(!this.playerDisabled(selectedPlayer)) {
              this.setState({ selectedPlayer });
            }
          }
        }

        componentDidMount() {
          document.addEventListener('keyup', this.onKeyup);
        }

        componentWillUnmount() {
          document.removeEventListener('keyup', this.onKeyup);
        }

        render({ players, day, playerTurn }, { selectedPlayer = -2 }) {
          const giveRole = day === 0 ? html`You are ${players[playerTurn].role === roles.MAFIAGOON ? html`the <span class="mafia">Mafia Goon</span>` : html`a <span class="town">Town Cop</span>`}.<br />` : null;
          return html`
            <form onSubmit=${this.choose}>
              ${giveRole}
              Choose a player to ${players[playerTurn].role === roles.MAFIAGOON ? "kill" : "investigate"}:
              <ol>
                ${players.map((player, i) => {
                  let investigation = players[playerTurn].investigations[i];
                  if(investigation !== null) investigation = html` (${investigation})`;
                  return html`
                    <li key=${i}><label>
                      <input type="radio" name="nightchoice" value=${i} checked=${selectedPlayer === i} disabled=${this.playerDisabled(i) !== null} onClick=${this.selectPlayer} />
                      ${player.name}
                      ${investigation}
                      ${this.playerDisabled(i)}
                    </label></li>`;
                })}
                <li><label><input type="radio" name="nightchoice" value=-1 checked=${selectedPlayer === -1} disabled=${this.blunder()} onClick=${this.selectPlayer} /><i>Nobody ${this.blunder()}</i></label></li>
              </ol>
              <button type="submit" disabled=${selectedPlayer === -2}>Confirm Choice</button>
            </form>
          `;
        }
      }

      function NightResult({ players, playerTurn, investigatedPlayer }) {
        const role = players[playerTurn].role;
        if(role === roles.MAFIAGOON) {
          return html`Your kill choice has been submitted.`;
        } else if(investigatedPlayer === -1) {
          return html`You did not investigate anyone tonight.`;
        } else {
          return html`As a result of your investigation, you believe that ${players[investigatedPlayer].name} is ${getInvestigationResult(role, players[investigatedPlayer].role)}.`;
        }
      }

      class DayChoice extends Component {
        selectPlayer = ({ target: { value } }) => this.setState({ selectedPlayer: parseInt(value) });

        playerDisabled(i) {
          if(!this.props.players[i].alive) {
            return html` <i>(Dead players cannot be lynched.)</i>`;
          } else {
            return null;
          }
        }

        lyloBlunder() {
          return this.props.preventBlunders && this.props.players.filter(player => player.alive).length <= 3 && "(Blunder: The Mafia would immediately win.)";
        }

        choose = event => {
          event.preventDefault();
          if(this.state.selectedPlayer !== -2) {
            this.props.choose(this.state.selectedPlayer);
          }
        }

        onKeyup = event => {
          if(event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) return;
          if(event.key === '6') {
            event.preventDefault();
            if(!this.lyloBlunder()) {
              this.setState({ selectedPlayer: -1 });
            }
          } else if(event.key >= '1' && event.key <= '5') {
            event.preventDefault();
            const selectedPlayer = parseInt(event.key) - 1;
            if(!this.playerDisabled(selectedPlayer)) {
              this.setState({ selectedPlayer });
            }
          }
        }

        componentDidMount() {
          document.addEventListener('keyup', this.onKeyup);
        }

        componentWillUnmount() {
          document.removeEventListener('keyup', this.onKeyup);
        }

        render({ players }, { selectedPlayer = -2 }) {
          return html`
            <form onSubmit=${this.choose}>
              Who did the Town vote to lynch?
              <ol>
                ${players.map((player, i) => html`
                  <li key=${i}><label>
                    <input type="radio" name="nightchoice" value=${i} checked=${selectedPlayer === i} disabled=${this.playerDisabled(i) !== null} onClick=${this.selectPlayer} />
                    ${player.name}
                    ${this.playerDisabled(i)}
                  </label></li>
                `)}
                <li><label><input type="radio" name="nightchoice" value=-1 checked=${selectedPlayer === -1} disabled=${this.lyloBlunder()} onClick=${this.selectPlayer} /><i>Nobody ${this.lyloBlunder()}</i></label></li>
              </ol>
              <button type="submit" disabled=${selectedPlayer === -2}>Confirm Choice</button>
            </form>
          `;
        }
      }

      class Dethy extends Component {
        state = {
          phase: phases.NAMEENTRY,
          day: 0,
          players: [
            {
              name: "Player 1",
              role: roles.MAFIAGOON,
              alive: true,
              investigations: [null, null, null, null, null],
            },
            {
              name: "Player 2",
              role: roles.SANECOP,
              alive: true,
              investigations: [null, null, null, null, null],
            },
            {
              name: "Player 3",
              role: roles.INSANECOP,
              alive: true,
              investigations: [null, null, null, null, null],
            },
            {
              name: "Player 4",
              role: roles.PARANOIDCOP,
              alive: true,
              investigations: [null, null, null, null, null],
            },
            {
              name: "Player 5",
              role: roles.NAIVECOP,
              alive: true,
              investigations: [null, null, null, null, null],
            },
          ],
          preventBlunders: true,
          playerTurn: 0,
          dyingPlayer: -1,
          investigatedPlayer: -1,
          actions: [{action: html`Night 0`, hidden: true}]
        };

        makeUpdateName = i => ({ target: { value: name } }) => this.setState(prevState => {
          const players = [...prevState.players];
          players[i] = {...players[i], name};
          return {players};
        });

        updatePreventBlunders = event => this.setState({ preventBlunders: event.target.checked });

        startGame = event => {
          event.preventDefault();
          this.setState(prevState => {
            const shuffledRoles = shuffleRoles();
            return {
              phase: phases.NIGHTPLAYER,
              day: 0,
              players: prevState.players.map(({ name }, i) => ({
                name,
                role: shuffledRoles[i],
                alive: true,
                investigations: [null, null, null, null, null],
              })),
              playerTurn: 0,
              dyingPlayer: -1,
              investigatedPlayer: -1,
              actions: [{action: html`Night 0`, hidden: true}]
            };
          });
        };

        showNightChoice = event => {
          event.preventDefault();
          this.setState({ phase: phases.NIGHTCHOICE });
        };

        confirmNightChoice = selectedPlayer => this.setState(prevState => {
          if(prevState.players[prevState.playerTurn].role === roles.MAFIAGOON) {
            return {
              dyingPlayer: selectedPlayer,
              phase: phases.NIGHTRESULT,
            };
          } else {
            const players = [...prevState.players], actions = [...prevState.actions];
            if(selectedPlayer !== -1) {
              const investigations = [...players[prevState.playerTurn].investigations];
              investigations[selectedPlayer] = getInvestigationResult(players[prevState.playerTurn].role, players[selectedPlayer].role);
              players[prevState.playerTurn] = {...players[prevState.playerTurn], investigations};
              actions.push({action: html`<span class="town">${prevState.players[prevState.playerTurn].name}</span> investigated <span class=${prevState.players[selectedPlayer].role === roles.MAFIAGOON ? "mafia" : "town"}>${prevState.players[selectedPlayer].name}</span>`, hidden: true});
            }
            return {
              investigatedPlayer: selectedPlayer,
              phase: phases.NIGHTRESULT,
              players,
              actions
            };
          }
        });

        advanceNight = event => {
          event.preventDefault();
          this.setState(prevState => {
            for(let i = prevState.playerTurn + 1; i < 5; ++i) {
              if(prevState.players[i].alive) {
                return {
                  phase: phases.NIGHTPLAYER,
                  playerTurn: i
                };
              }
            }
            const day = prevState.day + 1;
            const players = [...prevState.players], actions = [...prevState.actions];
            if(prevState.dyingPlayer !== -1) {
              players[prevState.dyingPlayer] = {...players[prevState.dyingPlayer], alive: false};
              actions.push({action: html`<span class="town">${players[prevState.dyingPlayer].name}</span> was killed`, hidden: false});
            }
            actions.push({action: html`Day ${day}`, hidden: false});
            return {
              phase: phases.DAY,
              day,
              players,
              actions
            }
          });
        };

        confirmDayChoice = selectedPlayer => this.setState(prevState => {
          const players = [...prevState.players], actions = [...prevState.actions];
          if(selectedPlayer !== -1) {
            players[selectedPlayer] = {...players[selectedPlayer], alive: false};
            actions.push({action: html`<span class=${prevState.players[selectedPlayer].role === roles.MAFIAGOON ? "mafia" : "town"}>${prevState.players[selectedPlayer].name}</span> was lynched`, hidden: false});
          }
          if((selectedPlayer !== -1 && players[selectedPlayer].role === roles.MAFIAGOON) || players.filter(player => player.alive).length <= 3) {
            return {
              phase: phases.ENDGAME,
              players,
              actions
            };
          } else {
            let playerTurn = -1;
            while(!players[++playerTurn].alive);
            actions.push({action: html`Night ${prevState.day}`, hidden: false});
            return {
              phase: phases.NIGHTPLAYER,
              players,
              playerTurn,
              actions
            };
          }
        });

        newGame = event => {
          event.preventDefault();
          this.setState({ phase: phases.NAMEENTRY });
        }

        constructor(props) {
          super(props);
          this.updateNames = [];
          for(let i = 0; i < 5; ++i) {
            this.updateNames[i] = this.makeUpdateName(i);
          }
        }

        onKeydown = event => {
          if(event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) return;
          if(event.key === 'Enter') {
            event.preventDefault();
            document.getElementsByTagName('button')[0].click();
          }
        }

        componentDidMount() {
          document.addEventListener('keydown', this.onKeydown);
        }

        componentWillUnmount() {
          document.removeEventListener('keydown', this.onKeydown);
        }

        render(props, state) {
          switch(state.phase) {
          case phases.NAMEENTRY:
            return html`
              <${NameEntry} players=${state.players} updateNames=${this.updateNames} preventBlunders=${state.preventBlunders} updatePreventBlunders=${this.updatePreventBlunders} startGame=${this.startGame} />
            `;
          case phases.NIGHTPLAYER:
            return html`
              <form onSubmit=${this.showNightChoice}>
                Give the device to ${state.players[state.playerTurn].name}, then press Continue once everyone else is looking away.<br />
                <button type="submit">Continue</button>
              </form>
            `;
          case phases.NIGHTCHOICE:
            return html`
              <${Actions} actions=${state.actions} />
              <${NightChoice} players=${state.players} preventBlunders=${state.preventBlunders} day=${state.day} playerTurn=${state.playerTurn} choose=${this.confirmNightChoice} />
            `;
          case phases.NIGHTRESULT:
            return html`
              <${Actions} actions=${state.actions} />
              <form onSubmit=${this.advanceNight}>
                <${NightResult} players=${state.players} playerTurn=${state.playerTurn} investigatedPlayer=${state.investigatedPlayer} /><br />
                <button type="submit">Continue</button>
              </form>
            `;
          case phases.DAY:
            return html`
              <${Actions} actions=${state.actions} />
              <${DayChoice} players=${state.players} preventBlunders=${state.preventBlunders} choose=${this.confirmDayChoice} />
            `;
          case phases.ENDGAME:
            return html`
              <${Actions} actions=${state.actions} showhidden />
              <form onSubmit=${this.newGame}>
                ${state.players.some(player => player.alive && player.role === roles.MAFIAGOON) ? html`<span class="mafia">Mafia Wins!</span>` : html`<span class="town">Town Wins!</span>`}<br />
                Role List:
                <ul>
                  ${state.players.map((player, i) => html`
                    <li key=${i} class=${player.role === roles.MAFIAGOON ? "mafia" : "town"}>${player.name} - ${player.role}</li>
                  `)}
                </ul>
                <button type="submit">New Game</button>
              </form>
            `;
          };
        }
      }

      window.addEventListener('load', function() {
        render(html`<${Dethy} />`, document.body);
      });
    </script>
  </head>
  <body>
  </body>
</html>
